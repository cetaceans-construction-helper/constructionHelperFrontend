# 모바일 3D 작업 기능 설계안

## 1. 목표
- 모바일에서 3D 모델을 보고 확대/축소/회전 가능
- 부재 선택 후 `작업 완료` / `추가 조치 필요` 상태 처리 가능
- 2D 미니맵을 함께 제공해 선택 정확도와 이동 효율 개선
- PC와 모바일을 분리하되, 코드 중복은 최소화

## 2. 핵심 의사결정
- 권장: **단일 코드베이스 + 라우팅 분리 + 공용 코어 로직 재사용**
- 즉, 앱은 하나로 유지하고, 화면은 PC/모바일 전용 컴포넌트로 나눈다.
- 모바일 화면은 **상단 3D 집중 영역 + 하단 상태 영역(미니맵/상태처리 전환)** 구조로 고정한다.

## 3. 구분 방식 비교 (라우팅 vs 반응형)
| 방식 | 설명 | 장점 | 단점 | 권장도 |
|---|---|---|---|---|
| 동일 라우트 + 반응형 분기 | `/helper/schedule/3d` 하나에서 breakpoint로 분기 | URL 단순 | 컴포넌트 비대화, 조건문 증가, QA 복잡 | 보통 |
| 라우트 분리 | PC: `/helper/schedule/3d`, 모바일: `/m/helper/schedule/3d` | 책임 분리 명확, 테스트 용이, UX 최적화 쉬움 | 라우트 추가 관리 필요 | **높음** |
| 앱 완전 분리 | PC/모바일 repo 분리 | 독립 개발 가능 | 개발/운영/QA 비용 급증 | 낮음 |

### 최종 권장안
- **라우트 분리 방식**을 사용한다.
- 단, 비즈니스 로직/API 호출/3D 엔진 제어는 공용 composable로 묶어 재사용한다.
- 모바일 UX는 반응형 축소가 아니라 모바일 전용 라우트에서 별도 구성한다.

## 4. 라우팅 설계

### 4.1 URL 전략
- PC: `#/helper/schedule/3d`
- 모바일: `#/m/helper/schedule/3d`
  - 현재 프로젝트가 `createWebHashHistory`를 사용하므로 실제 접근 URL은 `#` 기반

### 4.2 라우팅 규칙
- 모바일 UA 또는 뷰포트 조건 충족 시 `/helper/schedule/3d` 접근을 `/m/helper/schedule/3d`로 유도 가능
- 강제 전환 파라미터 제공 권장:
  - `?view=pc` 또는 `?view=mobile`
  - QA/운영 디버깅 시 유용
- 모바일 전용 기능(하단 미니맵/상태처리 전환 UI)은 `/m/...`에서만 제공하고, PC 라우트에는 넣지 않는다.

## 5. 컴포넌트 구조 제안

### 5.1 공용 코어 (재사용)
- `src/composables/schedule3d/useSchedule3dCore.ts` (신규)
  - 모델 로드
  - 부재 선택 상태
  - 작업 상태 업데이트 API
  - 카메라 이동 공통 함수
- `src/utils/three/Engine.ts` (기존 유지, 옵션 확장)

### 5.2 PC 전용 뷰
- 기존 유지:
  - `src/pages/helper/schedule/Schedule3dPage.vue`
  - `src/pages/helper/schedule/components/Viewer3dArea.vue`

### 5.3 모바일 전용 뷰 (신규)
- `src/pages/mobile/schedule/MobileSchedule3dPage.vue`
- `src/pages/mobile/schedule/components/MobileViewer3dArea.vue`
- `src/pages/mobile/schedule/components/MobileBottomPanel.vue`
- `src/pages/mobile/schedule/components/MobileStatusPanel.vue`
- `src/pages/mobile/schedule/components/MiniMap2d.vue`

## 6. 모바일 UX 설계

### 6.1 화면 레이아웃
- 상단: 최소 헤더 (뒤로가기, 필터, 모드)
- 본문 상단 대형 영역(권장 65~75vh): 3D Viewer 전용
- 하단 고정 영역(권장 25~35vh): 컨텍스트 패널
  - 기본 상태: `MiniMap2d` 표시
  - 부재 선택 상태: `MobileStatusPanel` 표시
    - 선택 부재 정보
    - `작업 완료`, `추가 조치 필요`, `메모` 액션

### 6.1.1 하단 영역 전환 규칙
- `selectedObject3d == null`이면 하단에 미니맵 표시
- `selectedObject3d != null`이면 하단을 상태처리 패널로 전환
- 상태처리 완료 또는 선택 해제 시 하단을 미니맵으로 복귀

### 6.2 제스처
- 핀치: 줌
- 한 손가락 드래그: 회전
- 두 손가락 드래그: 팬
- 탭: 부재 선택
- 길게 누르기(선택): 다중 선택 모드 (선택사항)

### 6.3 미니맵 동작
- 부재를 2D 포인트/폴리곤으로 표시
- 현재 카메라 뷰 영역 표시
- 미니맵 탭 시 카메라 해당 위치로 이동
- 층/구역 필터 버튼 제공
- 미니맵은 모바일에서 **하단 패널 기본 화면**으로 동작
- 부재 선택 중에는 미니맵 대신 상태처리 패널이 노출되므로, 필요 시 `미니맵으로 돌아가기` 버튼 제공

### 6.4 미니맵 생성 전략 (파일럿 확정)
- 외부 이미지 도면 방식은 파일럿 단계에서 사용하지 않는다.
- 파일럿에서는 **3D 모델 기반 자동 생성** 방식을 사용한다.

#### 6.4.1 생성 절차
- 로드된 Object3d를 `floorId/floorName` 기준으로 그룹핑한다.
- 각 부재의 2D 좌표는 모델의 중심점(또는 단순 bbox center)을 사용해 산출한다.
- 하단 미니맵은 층 탭 + 점/사각형 오버레이로 렌더링한다.
- 미니맵 탭 시 해당 부재 선택 + 카메라 target 이동을 수행한다.
- 3D 선택 시 미니맵 하이라이트를 동기화한다.

#### 6.4.2 운영 규칙
- 프로젝트 단위(`projectId`)로 미니맵 계산 결과를 캐시한다.
- 모델 변경 또는 프로젝트 변경 시 캐시를 무효화한다.
- 대량 데이터에서 성능 저하가 발생하면 점 단위 렌더로 degrade 한다.

## 7. 데이터/상태 모델 제안
- 부재 상태 enum (예시)
  - `PENDING`
  - `DONE`
  - `NEEDS_ACTION`
- 상태 변경 payload (예시)
  - `object3dId`
  - `status`
  - `note` (선택)
  - `updatedAt`
  - `updatedBy`

## 8. 성능 기준 (모바일 필수)
- `devicePixelRatio` 상한 적용 (예: `Math.min(window.devicePixelRatio, 1.5)`)
- 그림자 기본 off 또는 저품질
- selection 대상만 raycast 하도록 제한
- 미니맵 데이터는 경량 좌표만 사용
- 초기 로딩 후 점진 렌더링(필요 시)

## 9. 단계별 실행 계획 (리뷰 게이트 + 체크리스트)

### 9.0 진행 원칙
- [ ] 각 게이트는 **독립 PR(또는 독립 커밋 묶음)** 으로 분리한다.
- [ ] 각 게이트의 검증 체크리스트를 100% 통과한 뒤 다음 게이트로 이동한다.
- [ ] 리뷰어 승인(Approve) 없이 다음 게이트를 시작하지 않는다.
- [ ] 기존 PC 경로(`#/helper/schedule/3d`) 회귀 테스트를 매 게이트마다 수행한다.

### 9.1 Gate 0 - 베이스라인 고정
- [x] [작업] 현재 `3D 공정표` 동작 캡처(스크린샷/짧은 영상) 확보
- [x] [작업] 회귀 테스트 기준 시나리오 문서화(선택, 회전, 줌, 발주 진입)
- [x] [작업] 모바일 타깃 디바이스/브라우저 범위 확정
- [x] [검증] PC 기존 기능 동작 확인
- [x] [검증] 기존 API 호출/응답 에러 없음 확인
- [x] [리뷰] 베이스라인 자료가 PR 설명에 첨부되었는지 확인
- [x] [완료기준] “현재 동작 대비 무엇이 바뀌는지” 비교 가능한 상태

### 9.2 Gate 1 - 라우터 분리(모바일 경로) 스캐폴딩
- [x] [작업] 모바일 라우트 `#/m/helper/schedule/3d` 추가
- [x] [작업] 모바일 페이지 스켈레톤(`MobileSchedule3dPage.vue`) 추가
- [x] [작업] PC 라우트와 모바일 라우트를 명확히 분리
- [x] [작업] 강제 전환 파라미터(`?view=pc|mobile`) 처리 전략 반영
- [x] [검증] `#/m/helper/schedule/3d` 직접 접근 가능
- [x] [검증] `#/helper/schedule/3d` 기존 동작 유지
- [x] [검증] 인증 가드 동작(비로그인 리다이렉트) 동일
- [x] [리뷰] 라우팅 규칙이 문서/코드에서 일치하는지 확인
- [x] [완료기준] 라우팅 분리만으로 동작하며 기능 회귀 없음

### 9.3 Gate 2 - 리팩토링 보류 결정 (파일럿 우선)
- [x] [결정] 파일럿 단계에서는 공용 코어 리팩토링을 진행하지 않는다.
- [x] [작업] 리팩토링 TODO 문서를 별도 생성한다. (`TODO_MOBILE_3D_REFACTOR.md`)
- [x] [작업] Gate 3부터는 현 구조를 유지한 채 모바일 기능 검증을 우선한다.
- [x] [검증] 기존 PC 경로 동작 및 Gate 1 모바일 라우트 동작에 영향이 없다.
- [x] [리뷰] 협업 리스크/일정 대비 효과를 고려해 보류 판단에 합의한다.
- [x] [완료기준] Gate 2는 “보류 처리”로 종료하고, 리팩토링 항목은 TODO 백로그로 관리한다.

### 9.4 Gate 3 - 상단 패널 3D 모델 채우기
- [x] [작업] 상단 3D 영역에 실제 canvas/engine 연결
- [x] [작업] Object3d 목록 로드 후 모델 렌더링 연결
- [x] [작업] 확대/축소/회전/이동 기본 조작 연결
- [x] [작업] 로딩/에러 상태 UI를 상단 패널에 반영
- [ ] [검증] 상단 패널이 실제 3D 모델로 채워짐
- [ ] [검증] 다양한 모바일 해상도에서 상단 영역이 우선 확보됨
- [ ] [검증] 전체 페이지 스크롤 없이 3D 조작 가능
- [ ] [리뷰] 상단 패널 조작 UX(터치 반응/가시성) 확인
- [ ] [완료기준] 모바일 상단 패널에서 3D 모델 실사용 가능

### 9.5 Gate 4 - 하단 패널 미니맵 구현 (층별 지도)
- [ ] [작업] 모델 기반 층별 미니맵 데이터 생성 로직 구현
- [ ] [작업] `MiniMap2d` 컴포넌트로 하단 패널 기본 화면 채우기
- [ ] [작업] 층 탭 + 부재 마커(점/사각형) 렌더링
- [ ] [작업] 미니맵 탭 시 부재 선택 + 카메라 이동 연결
- [ ] [작업] 3D 선택과 미니맵 하이라이트 양방향 동기화
- [ ] [검증] 하단 패널이 미니맵으로 채워져 위치 선택 가능
- [ ] [검증] 층 전환 시 마커 데이터가 정확히 갱신
- [ ] [검증] 대량 부재에서도 기본 성능 유지
- [ ] [리뷰] 위치 직관성(층/구역 탐색성) 검토
- [ ] [완료기준] 하단 패널에서 층별 미니맵으로 위치 선택 가능

### 9.6 Gate 5 - 상태처리 패널 + 하단 전환 로직
- [ ] [작업] `selectedObject3d == null`일 때 미니맵 표시
- [ ] [작업] `selectedObject3d != null`일 때 상태처리 패널 표시
- [ ] [작업] 상태처리 패널에 `작업 완료`, `추가 조치 필요`, `메모` UI 구현
- [ ] [작업] 상태처리 API 요청/에러 처리 규칙 연결
- [ ] [작업] 상태처리 완료/선택해제 시 미니맵으로 복귀
- [ ] [검증] 빠른 연속 탭에서도 전환 상태 꼬임 없음
- [ ] [검증] 상태 변경 후 3D/패널/미니맵 동기화 일관성 유지
- [ ] [검증] API 실패 시 메시지 및 복구 동작 확인
- [ ] [리뷰] 상태 모델(enum/payload)이 백엔드 계약과 일치하는지 확인
- [ ] [완료기준] 미니맵↔상태처리 전환 + 상태처리 완료

### 9.7 Gate 6 - 미니맵 고도화/상호작용 2차
- [ ] [작업] 층/구역 필터 UX 고도화
- [ ] [작업] 카메라 뷰포트 박스 표시 정확도 개선
- [ ] [작업] projectId 기준 미니맵 캐시/무효화 적용
- [ ] [작업] 대량 부재 fallback 렌더링(간소화 모드) 적용
- [ ] [검증] 필터 적용 시 미니맵/3D 동시 반영
- [ ] [검증] 캐시 사용 시 초기 표시 속도 개선
- [ ] [검증] 저사양 환경에서 미니맵 조작 지연 완화
- [ ] [리뷰] 미니맵 사용성(목표 지점 찾기 시간) 재점검
- [ ] [완료기준] 파일럿 운영 가능한 미니맵 완성도 확보

### 9.8 Gate 7 - 모바일 성능/조작성 튜닝
- [ ] [작업] `devicePixelRatio` 상한 적용
- [ ] [작업] 모바일 품질 프로파일(그림자/후처리/라인두께) 분기
- [ ] [작업] 터치 제스처 민감도 조정(회전/팬/핀치)
- [ ] [작업] 선택 Raycast 범위 최적화
- [ ] [검증] 저사양 기기 발열/프레임 저하 허용 범위 확인
- [ ] [검증] 5분 연속 사용 시 프레임 급락/메모리 증가 체크
- [ ] [검증] 터치 오작동(원치 않는 선택/회전) 비율 점검
- [ ] [리뷰] 성능 지표(FPS, 메모리, 응답시간) 기록 확인
- [ ] [완료기준] 운영 가능한 성능 확보

### 9.9 Gate 8 - 회귀 QA + 출시 준비
- [ ] [작업] 전체 라우트 회귀 테스트(PC/모바일)
- [ ] [작업] 문서 갱신(라우팅, 컴포넌트 구조, QA 결과)
- [ ] [작업] 장애 대응 플랜(모바일 경로 롤백/비활성 토글) 준비
- [ ] [검증] 핵심 시나리오 E2E 또는 수동 테스트 통과
- [ ] [검증] 접근성/터치 타깃 최소 기준 통과
- [ ] [검증] 로그/모니터링 포인트 확인
- [ ] [리뷰] 최종 UAT 승인
- [ ] [완료기준] 릴리스 가능 상태

## 10. 왜 이 방식이 최선인가
- 모바일 UX 요구사항이 PC와 달라서 화면 계층 분리가 필요
- 하지만 로직을 공유하면 유지보수 비용이 크게 줄어듦
- 라우트 분리로 QA/운영/분석(모바일 전환율, 사용성)도 명확해짐

## 11. PR 분할 제안 (리뷰 단위)
- [x] PR-1: 라우팅 분리 + 모바일 스켈레톤 (Gate 1)
- [x] PR-2: Gate 2 보류 결정 + 리팩토링 TODO 문서화
- [ ] PR-3: 상단 패널 3D 모델 연동 (Gate 3)
- [ ] PR-4: 하단 패널 층별 미니맵 구현 (Gate 4)
- [ ] PR-5: 상태처리 패널 + 전환 + API (Gate 5)
- [ ] PR-6: 미니맵 고도화 + 성능 튜닝 + QA (Gate 6~8)

---

## 부록: 라우터 예시 (개념)
```ts
// PC
{ path: '/helper/schedule/3d', component: () => import('@/pages/helper/schedule/Schedule3dPage.vue') }

// Mobile
{ path: '/m/helper/schedule/3d', component: () => import('@/pages/mobile/schedule/MobileSchedule3dPage.vue') }
```
